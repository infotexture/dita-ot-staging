'use strict';define(['Common','lodash','jquery','jquery','bootstrap'],function(Common,_,$,jQuery){return function SearchController($toc,index){var common=Common(index);var titles=getTitles($toc);var $searchInput=$('#tocSearchInput');var $modal=$('#tocSearch');var isModelActive=false;var currentResult=-1;$modal.modal({show:false}).on('shown.bs.modal',onShow).on('hide.bs.modal',onHide);$searchInput.keyup(onType);$(document).keypress(openSearch);$(document).keydown(resultNavigation);function onType(){var value=$searchInput.val();var query=buildQuery(value);var results=_(titles).filter(function(node){return query.test(node.title)}).map(createResult).value();$('.modal-body').html(results);currentResult=-1;$modal.modal('handleUpdate');function createResult(node){return $('<p><a></a></p>').find('a').attr('href',node.url).text(node.title).click(selectResult).end()}function buildQuery(value){var query=_(value).map(function(c){switch(c){case '.':case '\\':return '\\'+c;default:return c;}}).join('.*?');return new RegExp(query,'gi')}function selectResult(event){event.preventDefault();event.stopPropagation();var $target=$(event.target);var href=$target.get(0).href;common.loadMain(href);$modal.modal('hide')}}function onShow(){isModelActive=true;$searchInput.val('').focus()}function onHide(){isModelActive=false;$('.modal-body').empty()}function openSearch(event){var $target=$(event.target);var key=event.which;if(!isModelActive&&$target.is(':not(:input)')&&key===116){event.preventDefault();event.stopPropagation();$modal.modal('show')}}function resultNavigation(event){if(isModelActive){switch(event.keyCode){case 40:currentResult++;var results=$('.modal-body').find('a');if(currentResult>=results.length){currentResult=results.length-1}results[currentResult].focus();event.preventDefault();event.stopPropagation();break;case 38:currentResult--;if(currentResult<0){currentResult=-1}else if(currentResult===-1){$searchInput.focus()}else {$('.modal-body').find('a')[currentResult].focus()}event.preventDefault();event.stopPropagation();break;}}}function getTitles($toc){return $toc.find('a').map(function(){var $node=$(this);return {title:$.trim($node.text()),url:new URI($node.attr('href')).absoluteTo(index).href()}}).toArray()}}});