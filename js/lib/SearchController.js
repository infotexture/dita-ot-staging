'use strict';define(['Common','jquery','jquery','bootstrap'],function(Common,$,jQuery){return function SearchController($toc,index){var common=Common(index);var titles=getTitles($toc);var $searchInput=$('#tocSearchInput');var $modal=$('#tocSearch');var isModelActive=false;var currentResult=-1;$modal.modal({show:false}).on('shown.bs.modal',onShow).on('hide.bs.modal',onHide);$searchInput.keyup(onType);var $help=$('#keyboardHelp');var isHelpActive=false;$help.modal({show:false}).on('shown.bs.modal',function(){isHelpActive=true}).on('hidden.bs.modal',function(){isHelpActive=false});$(document).keypress(openSearch);$(document).keydown(resultNavigation);function onType(event){if(event.which===37||event.which===39){return}var value=$searchInput.val();if(value.length===0){$('.modal-body').empty();$modal.modal('handleUpdate')}else {var query=buildQuery(value);var results=titles.filter(query.exact);if(results.length===0){results=titles.filter(query.lax)}$('.modal-body').html(results.map(createResult))}currentResult=-1;$modal.modal('handleUpdate');function createResult(node){return $('<p><a></a></p>').find('a').attr('href',node.url).text(node.title).click(selectResult).end();function selectResult(event){event.preventDefault();event.stopPropagation();var $target=$(event.target);var href=$target.get(0).href;common.loadMain(href);$modal.modal('hide')}}function buildQuery(value){var chars=value.trim().split('').map(function(c){switch(c){case '.':case '\\':return '\\'+c;case ' ':return '\\w+';default:return c;}});var _exact=new RegExp(chars.join(''),'gi');var _lax=new RegExp(chars.join('.*?'),'gi');return {exact:function exact(node){return _exact.test(node.title)},lax:function lax(node){return _lax.test(node.title)}}}}function onShow(){isModelActive=true;$searchInput.val('').focus()}function onHide(){isModelActive=false;$('.modal-body').empty()}function openSearch(event){var $target=$(event.target);var key=event.which;if($target.is(':input')||isModelActive||isHelpActive){}else if(key===116){event.preventDefault();event.stopPropagation();$modal.modal('show')}else if(key===63){console.log('show help');event.preventDefault();event.stopPropagation();$help.modal('show')}}function resultNavigation(event){if(isModelActive){switch(event.keyCode){case 40:currentResult++;var results=$('.modal-body').find('a');if(currentResult>=results.length){currentResult=results.length-1}results[currentResult].focus();event.preventDefault();event.stopPropagation();break;case 38:currentResult--;if(currentResult<0){currentResult=-1}else if(currentResult===-1){$searchInput.focus()}else {$('.modal-body').find('a')[currentResult].focus()}event.preventDefault();event.stopPropagation();break;}}}function getTitles($toc){return $toc.find('a').map(function(){var $node=$(this);return {title:$.trim($node.text()),url:new URI($node.attr('href')).absoluteTo(index).href()}}).toArray()}}});